
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>桌球發力訓練系統</title>
    <style>
        body, html {
            margin: 0;
            padding: 0px 30px;
            height: 100%;
            font-family: Arial, sans-serif;
        }
        .container {
            display: flex;
            height: 100%; 
            gap: 0px; 
        }
        .left-column {
            width: 65%; 
            display: flex;
            flex-direction: column;
            align-items: flex-start; 
        }
        .right-column {
            width: 35%;
            padding: 10px; 
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }
        .file-input-container {
            display: flex;
            gap: 30px; 
        }
        #myVideo {
            width: 80%;
            max-height: 55%;
            align-self: flex-end; 
            margin-right: 60px; 
        }
        #myChartContainer {
            height: 45%;
            width: 150%;
            margin-left: 80px; 
        }
        #myChart {
            width: 100%;
            height: 100%;
        }
        #timeSlider {
            width: 100%;
            margin-bottom: 20px;
        }
        .button {
            padding: 10px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        .file-input {
            display: none;
        }
        .custom-label {
            padding: 10px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            display: inline-block;
            text-align: center;
        }
        #results {
            margin-top: 20px;
            font-size: 16px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-column">
            <video id="myVideo" controls autoplay></video> 
            <div id="myChartContainer">
                <canvas id="myChart"></canvas>
            </div>
        </div>
        <div class="right-column">
            <div id="experimentTime" style="font-size: 18px; margin-bottom: 10px;"></div> 
            <div id="results"></div>
            <div class="file-input-container">
                <div>
                    <label for="videoFile" class="custom-label">選擇影片檔</label>
                    <input type="file" id="videoFile" accept="video/mp4,video/quicktime" class="file-input">
                    <div id="videoFileName" class="file-name"></div>
                </div>
                <div>
                    <label for="dataFile" class="custom-label">選擇數據檔</label>
                    <input type="file" id="dataFile" accept=".txt" class="file-input">
                    <div id="dataFileName" class="file-name"></div>
                </div>
                <button id="recordDataButton" class="button">錄影並收集數據</button>
            </div>
            <input type="range" id="timeSlider" min="0" max="100" value="0">
            <button id="startButton" class="button">開始</button>
            <button id="pauseButton" class="button">暫停</button>
            <button id="hitButton" class="button">記錄擊球時間</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const ctx = document.getElementById('myChart').getContext('2d');
        const myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Sensor Data',
                    data: [],
                    borderColor: 'rgba(75, 192, 192, 1)',
                    tension: 0.6
                }]
            },
            options: {
                animation: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Time'
                        },
                        ticks: {
                            autoSkip: false,
                        },
                        grid: {
                            display: true, 
                            drawOnChartArea: true 
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Value'
                        },
                        beginAtZero: true,
                        grid: {
                            display: true 
                        }
                    }
                }
            }
        });

        const video = document.getElementById('myVideo');
        const timeSlider = document.getElementById('timeSlider');
        const startButton = document.getElementById('startButton');
        const pauseButton = document.getElementById('pauseButton');
        const hitButton = document.getElementById('hitButton');
        const videoFile = document.getElementById('videoFile');
        const dataFile = document.getElementById('dataFile');

        let chartData = [];
        let updateInterval;
        let hitTimes = [];

        videoFile.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const fileType = file.type;

            if (fileType !== 'video/mp4' && fileType !== 'video/quicktime') {
                alert('請選擇 MP4 或 MOV 格式的影片檔案。');
                return;
            }

            const fileURL = URL.createObjectURL(file);
            video.src = fileURL;

            if (fileType === 'video/mp4') {
                video.type = 'video/mp4';
            } else if (fileType === 'video/quicktime') {
                video.type = 'video/quicktime';
            }
        });

        dataFile.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                chartData = parseDataFile(content);
                updateChart(0);
            };
            reader.readAsText(file);
        });

        function parseDataFile(content) {
            let millisecondCounter = 1; 
            return content.split('\n').map(line => {
                const [time, value] = line.trim().split(' ');
                const newTime = time.replace(/:\d{3}$/, '') + `:${millisecondCounter++ % 10}`; 
                return { time: newTime, value: parseFloat(value) };
            }).filter(item => !isNaN(item.value));
        }

        function updateChart(currentTime) {
            const currentIndex = Math.floor(currentTime * 10);
            const displayData = chartData.slice(Math.max(0, currentIndex - 29), currentIndex + 1);

            myChart.data.labels = displayData.map(item => item.time);
            myChart.data.datasets[0].data = displayData.map(item => item.value);
            myChart.update('none');
        }

        function startUpdate() {
            updateInterval = setInterval(() => {
                const currentTime = video.currentTime;
                timeSlider.value = (currentTime / video.duration) * 100;
                updateChart(currentTime);
            }, 100);
        }

        function stopUpdate() {
            clearInterval(updateInterval);
        }

        video.addEventListener('play', startUpdate);
        video.addEventListener('pause', stopUpdate);

        startButton.addEventListener('click', () => {
            video.play();
        });

        pauseButton.addEventListener('click', () => {
            video.pause();
        });

        timeSlider.addEventListener('input', () => {
            const time = (timeSlider.value / 100) * video.duration;
            video.currentTime = time;
            updateChart(time);
        });

        hitButton.addEventListener('click', () => { 
            const videoTime = video.currentTime;
            const currentIndex = Math.floor(videoTime * 10);
            const dataItem = chartData[currentIndex] || { time: "未知", value: "無數據" };

            hitTimes.push({ videoTime, dataTime: dataItem.time, dataValue: dataItem.value });
            hitTimes.sort((a, b) => a.videoTime - b.videoTime);

            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = ''; 
            hitTimes.forEach(hit => {
                resultsDiv.innerHTML += `影片時間: ${hit.videoTime.toFixed(2)} 秒, 數據時間: ${hit.dataTime}, 數據數值: ${hit.dataValue} <br>`;
            });
        });

        let isRecording = false;
        let mediaRecorder;
        let recordedChunks = [];

        document.getElementById('recordDataButton').addEventListener('click', async function () {
            if (!isRecording) {
                await startRecording();
                await connectToBluetoothDevice();
                this.textContent = '停止錄影';
            } else {
                stopRecording();
                this.textContent = '錄影並收集數據';
            }
            isRecording = !isRecording;
        });

        // 開始錄影的函數
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                document.getElementById('myVideo').srcObject = stream;

                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                mediaRecorder.onstop = function() {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    document.getElementById('myVideo').src = URL.createObjectURL(blob);
                    recordedChunks = [];
                };
                mediaRecorder.start();
            } catch (error) {
                console.error('無法訪問攝像頭:', error);
            }
        }

        function stopRecording() {
            mediaRecorder.stop();
            document.getElementById('myVideo').srcObject = null;
        }

        // 藍牙連接函數
        async function connectToBluetoothDevice() {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['12345678-1234-5678-1234-56789abcdef0']
                });

                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('12345678-1234-5678-1234-56789abcdef0');
                const characteristic = await service.getCharacteristic('12345678-1234-5678-1234-56789abcdef1');

                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleData);

                console.log('藍牙連接成功');
            } catch (error) {
                console.error('藍牙連接失敗:', error);
            }
        }

        // 處理藍牙數據
function handleData(event) {
    const value = new TextDecoder().decode(event.target.value);  // 解碼為字符串
    const emgValue = parseInt(value.trim(), 10);  // 將字符串轉換為整數
    console.log('接收到的 EMG 數據:', emgValue);  // 檢查接收到的數據

       if (!isNaN(emgValue)) {
        updateChartWithEMG(emgValue);  // 確保只將有效數據更新到圖表
    }
}


        // 更新圖表數據
function updateChartWithEMG(emgValue) {
    if (myChart.data.labels.length > 50) {
        myChart.data.labels.shift();  // 刪除最舊的標籤
        myChart.data.datasets[0].data.shift();  // 刪除最舊的數據
    }

    // 獲取當前時間並自訂格式為 分:秒:毫秒/100
    const now = new Date();
    const minutes = now.getMinutes().toString().padStart(2, '0');  // 兩位數分鐘
    const seconds = now.getSeconds().toString().padStart(2, '0');  // 兩位數秒鐘
    const milliseconds = Math.floor(now.getMilliseconds() / 100);  // 毫秒除以 100 得到 0~9

    const formattedTime = `${minutes}:${seconds}:${milliseconds}`;

    // 將時間標籤推入圖表
    myChart.data.labels.push(formattedTime);
    // 將接收到的 EMG 數據推入圖表
    myChart.data.datasets[0].data.push(emgValue);
    
    // 更新圖表
    myChart.update();
}

    </script>
</body>
</html>
